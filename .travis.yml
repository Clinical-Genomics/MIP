language: perl
perl:
  - "5.26"
sudo: required
 
before_install:
## Install SSL
  - sudo apt-get update
  - sudo apt-get install libssl1.0.0 libssl-dev libcrypto++9 libcrypto++-dev
  - cd /lib/x86_64-linux-gnu
  - sudo ln -s libssl.so.1.0.0 libssl.so.10
  - sudo ln -s libcrypto.so.1.0.0 libcrypto.so.10
  - cd -

## Install conda
  - wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda info -a
  
## Download cpan libraries
## For some reason DB_File installation fails, it is not needed for the test
  - sed -i '/DB_File/d' ./definitions/cpanfile
  - cd definitions; cpanm --quiet --notest --installdeps .
  - cd -
## Set up for cpanm dependencies test
  - cpanm --notest Devel::Cover::Report::Coveralls

install: 
## Test installation script and gather coverage information
  - PERL5OPT=-MDevel::Cover=-coverage,statement,branch,condition,path,subroutine perl t/mip_install.test
## Generate installation script 
  - perl mip install rare_disease --config definitions/install_rare_disease_parameters.yaml --quiet --bash_set_errexit --install emip esvdb epeddy epy3 --envn emip=mip_travis --snpg GRCh37.75 --skip gatk
## Install MIP rare disease
  - bash mip.sh

script:
## Test MIP
  - source activate mip_travis
  - cd /lib/x86_64-linux-gnu
  - sudo ln -s "$ROOTSYS"/lib/*so .
  - cd -
## Set-up test coverage for test directory "t" and "analyse rare disease pipeline
  - PERL5OPT=-MDevel::Cover=-coverage,statement,branch,condition,path,subroutine prove -lr t
  - PERL5OPT=-MDevel::Cover=-coverage,statement,branch,condition,path,subroutine perl t/mip_analyse_rare_disease.test
  - cover

after_success:
## Generate report for coveralls
  - cover -report coveralls
